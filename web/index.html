<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EZ Redirect</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="container">

    <header class="app-header">
        <div>
            <h1>EZ Redirect</h1>
            <p class="subtitle">Instant propagation redirects on your LAN.</p>
        </div>
        <button class="icon-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
    </header>

    <!-- CURRENT REDIRECT -->
    <section class="card">
        <h2>Current Redirect URL</h2>
        <input id="current-url-input" placeholder="https://example.com">
        <p id="temp-timer" class="temp-timer hidden"></p>
        <button onclick="applyCurrentUrl()">Apply URL</button>
    </section>

    <!-- PRESETS -->
    <section class="card">
        <div class="section-header">
            <h2>Presets</h2>
            <button class="icon-btn" onclick="openAddPreset()" title="Add preset">Ôºã</button>
        </div>
        <div id="preset-list" class="preset-list"></div>
    </section>

    <!-- TEMPORARY -->
    <section class="card">
        <h2>Temporary Redirect</h2>
        <input id="temp-url" placeholder="Temporary URL">
        <div class="temp-row">
            <input id="temp-seconds" type="number" value="300" min="10" step="10">
            <span class="temp-label">seconds</span>
        </div>
        <button onclick="setTemp()">Activate Temporary Redirect</button>
    </section>

</div>

<!-- PRESET MODAL -->
<div id="preset-modal" class="modal hidden">
    <div class="modal-content card">

        <!-- MODAL HEADER -->
        <div class="modal-header">
            <h2 id="modal-title">Add Preset</h2>

            <div class="modal-icons">
                <button id="make-default-btn" class="icon-only-btn hidden" onclick="makeDefault()" title="Make Default">‚≠ê</button>
                <button id="delete-preset-btn" class="icon-only-btn hidden" onclick="deletePreset()" title="Delete">üóë</button>
            </div>
        </div>

        <!-- INPUTS -->
        <input id="preset-name" placeholder="Preset Name">
        <input id="preset-url" placeholder="https://example.com">

        <!-- MODAL FOOTER -->
        <div class="modal-buttons">
            <button class="secondary" onclick="closePresetModal()">Cancel</button>
            <button onclick="savePreset()">Save</button>
        </div>

    </div>
</div>

<!-- SETTINGS MODAL -->
<!-- SETTINGS MODAL -->
<div id="settings-modal" class="modal hidden">
    <div class="modal-content card">

        <div class="modal-header">
            <h2>Settings</h2>
        </div>

        <!-- PORT SECTION -->
        <div class="settings-group">
            <h3>Port</h3>
            <p class="settings-help">The port the service listens on. Changing requires a restart.</p>

            <div class="port-row">
                <input id="port-input" type="number" min="1024" max="65535">
            </div>

            <p id="port-status" class="settings-note"></p>
        </div>

        <!-- SECURITY SECTION -->
        <div class="settings-group">
            <h3>API Security</h3>

            <div class="toggle-row">
                <input type="checkbox" id="api-key-enabled">
                <label for="api-key-enabled">Require API Key for Remote Triggers</label>
            </div>

            <label>API Key</label>
            <div class="api-row">
                <input id="api-key-value" placeholder="Enter custom API key">
                <button class="small-btn" onclick="saveApiKey()">Save</button>
            </div>
        </div>

        <!-- FOOTER BUTTONS -->
        <div class="modal-buttons">
            <button class="secondary" onclick="closeSettings()">Close</button>
            <button onclick="saveSettings()">Save</button>
        </div>

    </div>
</div>


<script>
    let editingPreset = null;
    let securityState = { api_key_enabled: false, api_key: "" };
    let currentPort = 8000;
    let timerInterval = null;

    function clearExistingTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        document.getElementById("temp-timer").classList.add("hidden");
    }

    /* ============================
       LOAD CURRENT URL + TIMER
    ============================ */

    async function loadCurrent() {
        try {
            const res = await fetch('/api/current');
            const data = await res.json();
            const timerEl = document.getElementById("temp-timer");

            document.getElementById('current-url-input').value = data.current_url || "";
            clearExistingTimer();

            if (data.expires_at) {
                function updateTimer() {
                    const now = Date.now() / 1000;
                    let remaining = Math.max(0, Math.floor(data.expires_at - now));

                    if (remaining <= 0) {
                        timerEl.classList.add("hidden");
                        clearExistingTimer();
                        // Don't call loadCurrent() here ‚Äì avoids infinite loop
                        return;
                    }

                    const mins = String(Math.floor(remaining / 60)).padStart(2, '0');
                    const secs = String(remaining % 60).padStart(2, '0');

                    timerEl.innerText = `Temporary override: ${mins}:${secs}`;
                    timerEl.classList.remove("hidden");
                }

                updateTimer();
                timerInterval = setInterval(updateTimer, 1000);
            }
        } catch (err) {
            console.error("Error loading current URL:", err);
        }
    }

    /* ============================
       PRESET LIST + UI
    ============================ */

    async function loadPresets() {
        try {
            const res = await fetch('/api/presets');
            const presets = await res.json();
            const container = document.getElementById('preset-list');

            container.innerHTML = "";

            Object.entries(presets).forEach(([name, data]) => {
                const url = data.url;

                const row = document.createElement("div");
                row.className = "preset-row";

                // Make the entire row clickable
                row.onclick = () => applyPresetFromUI(url);

                const btn = document.createElement("div");
                btn.className = "preset-btn";
                btn.innerHTML = `
                    <img src="https://www.google.com/s2/favicons?domain=${encodeURIComponent(url)}" class="favicon">
                    <span>${name}</span>
                `;

                const menu = document.createElement("button");
                menu.className = "icon-btn small";
                menu.innerText = "‚ãØ";
                // Prevent menu click from triggering preset activation
                menu.onclick = (e) => {
                    e.stopPropagation();
                    openEditPreset(name, url);
                };

                row.appendChild(btn);
                row.appendChild(menu);
                container.appendChild(row);
            });
        } catch (err) {
            console.error("Error loading presets:", err);
        }
    }

    async function applyPresetFromUI(url) {
        try {
            clearExistingTimer();

            await fetch(
                "/api/set",
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ url })
                }
            );

            loadCurrent();
        } catch (err) {
            console.error("Error applying preset:", err);
        }
    }

    /* ============================
       APPLY / TEMPORARY URL
    ============================ */

    async function applyCurrentUrl() {
        try {
            clearExistingTimer();
            const url = document.getElementById('current-url-input').value;

            await fetch(
                "/api/set",
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ url })
                }
            );

            loadCurrent();
        } catch (err) {
            console.error("Error applying current URL:", err);
        }
    }

    async function setTemp() {
        try {
            clearExistingTimer();
            const url = document.getElementById("temp-url").value;
            const seconds = document.getElementById("temp-seconds").value;

            await fetch(
                "/api/temp",
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ url, seconds })
                }
            );

            loadCurrent();
        } catch (err) {
            console.error("Error setting temporary URL:", err);
        }
    }

    /* ============================
       PRESET MODAL FUNCTIONS
    ============================ */

    function openAddPreset() {
        editingPreset = null;
        document.getElementById("modal-title").innerText = "Add Preset";

        document.getElementById("preset-name").value = "";
        document.getElementById("preset-url").value = "";

        document.getElementById("delete-preset-btn").classList.add("hidden");
        document.getElementById("make-default-btn").classList.add("hidden");

        document.getElementById("preset-modal").classList.remove("hidden");
    }

    function openEditPreset(name, url) {
        editingPreset = name;

        document.getElementById("modal-title").innerText = "Edit Preset";
        document.getElementById("preset-name").value = name;
        document.getElementById("preset-url").value = url;

        document.getElementById("delete-preset-btn").classList.remove("hidden");
        document.getElementById("make-default-btn").classList.remove("hidden");

        document.getElementById("preset-modal").classList.remove("hidden");
    }

    function closePresetModal() {
        document.getElementById("preset-modal").classList.add("hidden");
    }

    async function savePreset() {
        const name = document.getElementById("preset-name").value.trim();
        const url = document.getElementById("preset-url").value.trim();

        if (!name || !url) return;

        try {
            if (editingPreset && editingPreset !== name) {
                await fetch("/api/presets/rename", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ old: editingPreset, new: name })
                });
            }

            await fetch("/api/presets/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, url })
            });

            closePresetModal();
            loadPresets();
        } catch (err) {
            console.error("Error saving preset:", err);
        }
    }

    async function deletePreset() {
        if (!editingPreset) return;

        try {
            await fetch("/api/presets/delete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: editingPreset })
            });

            closePresetModal();
            loadPresets();
        } catch (err) {
            console.error("Error deleting preset:", err);
        }
    }

    async function makeDefault() {
        if (!editingPreset) return;

        const url = document.getElementById("preset-url").value.trim();

        try {
            await fetch("/api/set-default", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url })
            });

            closePresetModal();
            loadPresets();
            loadCurrent();
        } catch (err) {
            console.error("Error setting default URL:", err);
        }
    }

    /* ============================
       SETTINGS (PORT + SECURITY)
    ============================ */

    async function loadPort() {
        try {
            const res = await fetch("/api/port");
            const data = await res.json();
            currentPort = data.port || 8000;
            document.getElementById("port-input").value = currentPort;
            document.getElementById("port-status").innerText =
                `Current service port: ${currentPort}`;
        } catch (err) {
            console.error("Error loading port:", err);
        }
    }

    async function loadSecurity() {
        try {
            securityState = await fetch("/api/security/status").then(r => r.json());

            document.getElementById("api-key-enabled").checked = !!securityState.api_key_enabled;
            document.getElementById("api-key-value").value = securityState.api_key || "";

        } catch (err) {
            console.error("Error loading security settings:", err);
        }
    }

    function openSettings() {
        document.getElementById("settings-modal").classList.remove("hidden");
        loadPort();
        loadSecurity();
    }

    function closeSettings() {
        document.getElementById("settings-modal").classList.add("hidden");
    }

    async function saveSettings() {
        // Save port
        const portVal = parseInt(document.getElementById("port-input").value, 10);
        if (!isNaN(portVal) && portVal >= 1024 && portVal <= 65535 && portVal !== currentPort) {
            try {
                const res = await fetch("/api/port", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ port: portVal })
                });
                const data = await res.json();
                currentPort = data.port;
                document.getElementById("port-status").innerText =
                    `Port updated to ${currentPort}. Restart service to apply.`;
            } catch (err) {
                console.error("Error saving port:", err);
            }
        }

        // Save security toggle + key (if changed)
        const enabledCheckbox = document.getElementById("api-key-enabled");
        const desiredEnabled = enabledCheckbox.checked;

        try {
            if (desiredEnabled !== !!securityState.api_key_enabled) {
                securityState = await fetch("/api/security/toggle", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ enabled: desiredEnabled })
                }).then(r => r.json());
            }

            const keyInputVal = document.getElementById("api-key-value").value.trim();
            if (keyInputVal && keyInputVal !== (securityState.api_key || "")) {
                securityState = await fetch("/api/security/set-key", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ api_key: keyInputVal })
                }).then(r => r.json());
            }
        } catch (err) {
            console.error("Error saving security settings:", err);
        }

        closeSettings();
    }

    async function saveApiKey() {
        const key = document.getElementById("api-key-value").value.trim();

        if (!key) {
            alert("API key cannot be empty.");
            return;
        }

        try {
            securityState = await fetch("/api/security/set-key", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ api_key: key })
            }).then(r => r.json());

            alert("API key saved!");
        } catch (err) {
            console.error("Error saving API key:", err);
        }
    }

    // INITIAL LOAD
    loadCurrent();
    loadPresets();
</script>


</body>
</html>
